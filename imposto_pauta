begin;
delete FROM t_vars WHERE grp = 'QSQL' AND id = emp2long('INFO') and ord = 11 ;
INSERT INTO t_vars VALUES (0, 'QSQL', emp2long('INFO'), 11, 30, 3, 0, 'with cte_impostos as (
select distinct t1.S_CATEGORIA_IMPOSTO 
     , t2.s_codigo_imposto
     , t1.D_INDICE_PRIORIDADE
     , ( ( (select cast(valor as real) from temp_ativos where s_nome = ''preco_venda'')  
         * ( ( 100
             + coalesce(t2.D_ALIQUOTA_MODIFICACAO_BASE,0)
             )
           / 100 
           ) 
         ) 
       * ( t2.D_ALIQUOTA_IMPOSTO
         / 100
         ) 
       ) as d_valor_imposto
  from tp_regra_imposto t1 
  join tp_imposto_orig_dest_produto t2 on (t1.S_CATEGORIA_IMPOSTO = t2.S_CATEGORIA_IMPOSTO and t1.u_orgvenda = t2.u_orgvenda)
 where t1.S_ID_TIPO_TRANSACAO_OM = (select t1.u_codtranscab 
                                      from tp_transacoes t1
                                      join tp_orgven_tabela_produto_st t2 on (t1.u_ou=( case when t1.u_oi = 801
                                                                                              and t2.s_codproduto = ''1000000125''
                                                                                              and (select cast(valor as real) from temp_ativos where s_nome = ''preco_venda'') < 3
                                                                                             then 6
                                                                                             when t1.u_oi = 801
                                                                                              and t2.s_codproduto = ''1000000125''
                                                                                              and (select cast(valor as real) from temp_ativos where s_nome = ''preco_venda'') >= 3
                                                                                             then 7
                                                                                             WHEN (select s_codigo 
                                                                                                     from ftsl_cate 
                                                                                                    where u_pkey = (select u_categoria
                                                                                                                      from ftsl_clie
                                                                                                                     where u_pkey = (select cast(valor as integer)
                                                                                                                                       from temp_ativos
                                                                                                                                      where s_nome = ''pk_cliente''
                                                                                                                                    )
                                                                                                                   )
                                                                                                  ) = ''CONTRIB_REG_ESPEC''
                                                                                             THEN 8
                                                                                             else t2.u_status
                                                                                         end
                                                                                      ) 
                                                                              and t1.u_oi = t2.u_orgvenda 
                                                                              and t2.s_uf = ( select s_uf 
                                                                                                from ftsl_ende
                                                                                               where s_codcliente = (select s_codigo 
                                                                                                                       from ftsl_clie
                                                                                                                      where u_pkey = (select cast(valor as integer)
                                                                                                                                        from temp_ativos
                                                                                                                                       where s_nome = ''pk_cliente''
                                                                                                                                     )
                                                                                                                    )
                                                                                            )
                                                                             )
                                      join ftsl_tven t3 on (t3.s_tipovenda = t1.s_descricao)
                                     where t2.u_codproduto_pk = (select cast(valor as integer)
                                                                from temp_ativos
                                                               where s_nome = ''pk_produto''
                                                             )
                                       and t3.u_pkey = (select cast(valor as integer)
                                                          from temp_ativos
                                                         where s_nome = ''pk_tipo_venda''
                                                       )
                                       and t1.u_oi = (select u_orgvenda 
                                         from ftsl_orgv
                                        where u_pkey = (select cast(valor as integer)
                                                          from temp_ativos
                                                         where s_nome = ''pk_org_venda''
                                                       )
                                      )
                                    )
   and t1.S_CATEGORIA_CLIENTE = (select s_codigo 
                                   from ftsl_cate 
                                  where u_pkey = (select u_categoria
                                                    from ftsl_clie
                                                   where u_pkey = (select cast(valor as integer)
                                                                     from temp_ativos
                                                                    where s_nome = ''pk_cliente''
                                                                  )
                                                 )
                                )                                
and t1.u_orgvenda = (select u_orgvenda 
                                         from ftsl_orgv
                                        where u_pkey = (select cast(valor as integer)
                                                          from temp_ativos
                                                         where s_nome = ''pk_org_venda''
                                                       )
                                      )
   and t2.s_codproduto = (select s_codproduto
                            from ftsl_prod
                           where u_pkey = (select cast(valor as integer)
                                             from temp_ativos
                                            where s_nome = ''pk_produto''
                                          )
                         )
   and t2.s_uf_origem = (select s_uf 
                          from tp_ov
                         where u_oi = (select u_orgvenda 
                                         from ftsl_orgv
                                        where u_pkey = (select cast(valor as integer)
                                                          from temp_ativos
                                                         where s_nome = ''pk_org_venda''
                                                       )
                                      )  
                        )
   and t2.s_uf_destino = (select s_uf 
                            from ftsl_ende
                           where s_codcliente = (select s_codigo 
                                                   from ftsl_clie
                                                  where u_pkey = (select cast(valor as integer)
                                                                    from temp_ativos
                                                                   where s_nome = ''pk_cliente''
                                                                 )
                                                )
                         )
   and t1.s_codregra = ''GET_EXC_ITEM_TX_CODE''
 union all
select distinct t1.S_CATEGORIA_IMPOSTO 
     , t2.s_codigo_imposto
     , t1.D_INDICE_PRIORIDADE
     , ( ( (select cast(valor as real) from temp_ativos where s_nome = ''preco_venda'')  
         * ( ( 100
             + coalesce(t2.D_ALIQUOTA_MODIFICACAO_BASE,0)
             )
           / 100 
           ) 
         ) 
       * ( t2.D_ALIQUOTA_IMPOSTO
         / 100
         ) 
       ) as d_valor_imposto
  from tp_regra_imposto t1 
  join tp_imposto_origem_destino t2 on (t1.S_CATEGORIA_IMPOSTO = t2.S_CATEGORIA_IMPOSTO and t1.u_orgvenda = t2.u_orgvenda)
 where t1.S_ID_TIPO_TRANSACAO_OM = (select t1.u_codtranscab 
                                      from tp_transacoes t1
                                      join tp_orgven_tabela_produto_st t2 on (t1.u_ou=( case when t1.u_oi = 801
                                                                                              and t2.s_codproduto = ''1000000125''
                                                                                              and (select cast(valor as real) from temp_ativos where s_nome = ''preco_venda'') < 3
                                                                                             then 6
                                                                                             when t1.u_oi = 801
                                                                                              and t2.s_codproduto = ''1000000125''
                                                                                              and (select cast(valor as real) from temp_ativos where s_nome = ''preco_venda'') >= 3
                                                                                             then 7
                                                                                             WHEN (select s_codigo 
                                                                                                     from ftsl_cate 
                                                                                                    where u_pkey = (select u_categoria
                                                                                                                      from ftsl_clie
                                                                                                                     where u_pkey = (select cast(valor as integer)
                                                                                                                                       from temp_ativos
                                                                                                                                      where s_nome = ''pk_cliente''
                                                                                                                                    )
                                                                                                                   )
                                                                                                  ) = ''CONTRIB_REG_ESPEC''
                                                                                             THEN 8
                                                                                             else t2.u_status
                                                                                         end
                                                                                      ) 
                                                                              and t1.u_oi = t2.u_orgvenda 
                                                                              and t2.s_uf = ( select s_uf 
                                                                                                from ftsl_ende
                                                                                               where s_codcliente = (select s_codigo 
                                                                                                                       from ftsl_clie
                                                                                                                      where u_pkey = (select cast(valor as integer)
                                                                                                                                        from temp_ativos
                                                                                                                                       where s_nome = ''pk_cliente''
                                                                                                                                     )
                                                                                                                    )
                                                                                            )
                                                                             )
                                      join ftsl_tven t3 on (t3.s_tipovenda = t1.s_descricao)
                                     where t2.u_codproduto_pk = (select cast(valor as integer)
                                                                from temp_ativos
                                                               where s_nome = ''pk_produto''
                                                             )
                                       and t3.u_pkey = (select cast(valor as integer)
                                                          from temp_ativos
                                                         where s_nome = ''pk_tipo_venda''
                                                       )
                                       and t1.u_oi = (select u_orgvenda 
                                         from ftsl_orgv
                                        where u_pkey = (select cast(valor as integer)
                                                          from temp_ativos
                                                         where s_nome = ''pk_org_venda''
                                                       )
                                      )
                                    )
   and t1.S_CATEGORIA_CLIENTE = (select s_codigo 
                                   from ftsl_cate 
                                  where u_pkey = (select u_categoria
                                                    from ftsl_clie
                                                   where u_pkey = (select cast(valor as integer)
                                                                     from temp_ativos
                                                                    where s_nome = ''pk_cliente''
                                                                  )
                                                 )
                                )                                
and t1.u_orgvenda = (select u_orgvenda 
                                         from ftsl_orgv
                                        where u_pkey = (select cast(valor as integer)
                                                          from temp_ativos
                                                         where s_nome = ''pk_org_venda''
                                                       )
                                      )
   and t2.s_uf_origem = (select s_uf 
                          from tp_ov
                         where u_oi = (select u_orgvenda 
                                         from ftsl_orgv
                                        where u_pkey = (select cast(valor as integer)
                                                          from temp_ativos
                                                         where s_nome = ''pk_org_venda''
                                                       )
                                      )  
                        )
   and t2.s_uf_destino = (select s_uf 
                            from ftsl_ende
                           where s_codcliente = (select s_codigo 
                                                   from ftsl_clie
                                                  where u_pkey = (select cast(valor as integer)
                                                                    from temp_ativos
                                                                   where s_nome = ''pk_cliente''
                                                                 )
                                                )
                         )
   and t1.s_codregra = ''GET_LOCATION_TX_CODE''
 union all
select distinct t1.S_CATEGORIA_IMPOSTO
     , t2.s_codigo_imposto 
     , t1.D_INDICE_PRIORIDADE
     , ( ( (select cast(valor as real) from temp_ativos where s_nome = ''preco_venda'')  
         * ( ( 100
             + coalesce(t2.D_ALIQUOTA_MODIFICACAO_BASE,0)
             )
           / 100 
           ) 
         ) 
       * ( t2.D_ALIQUOTA_IMPOSTO
         / 100
         ) 
       ) as d_valor_imposto
  from tp_regra_imposto t1 
  join tp_imposto_class_fiscal t2 on (t1.S_CATEGORIA_IMPOSTO = t2.S_CATEGORIA_IMPOSTO and t1.u_orgvenda = t2.u_orgvenda)
 where t1.S_ID_TIPO_TRANSACAO_OM = (select t1.u_codtranscab 
                                      from tp_transacoes t1
                                      join tp_orgven_tabela_produto_st t2 on (t1.u_ou=( case when t1.u_oi = 801
                                                                                              and t2.s_codproduto = ''1000000125''
                                                                                              and (select cast(valor as real) from temp_ativos where s_nome = ''preco_venda'') < 3
                                                                                             then 6
                                                                                             when t1.u_oi = 801
                                                                                              and t2.s_codproduto = ''1000000125''
                                                                                              and (select cast(valor as real) from temp_ativos where s_nome = ''preco_venda'') >= 3
                                                                                             then 7
                                                                                             WHEN (select s_codigo 
                                                                                                     from ftsl_cate 
                                                                                                    where u_pkey = (select u_categoria
                                                                                                                      from ftsl_clie
                                                                                                                     where u_pkey = (select cast(valor as integer)
                                                                                                                                       from temp_ativos
                                                                                                                                      where s_nome = ''pk_cliente''
                                                                                                                                    )
                                                                                                                   )
                                                                                                  ) = ''CONTRIB_REG_ESPEC''
                                                                                             THEN 8
                                                                                             else t2.u_status
                                                                                         end
                                                                                      ) 
                                                                              and t1.u_oi = t2.u_orgvenda 
                                                                              and t2.s_uf = ( select s_uf 
                                                                                                from ftsl_ende
                                                                                               where s_codcliente = (select s_codigo 
                                                                                                                       from ftsl_clie
                                                                                                                      where u_pkey = (select cast(valor as integer)
                                                                                                                                        from temp_ativos
                                                                                                                                       where s_nome = ''pk_cliente''
                                                                                                                                     )
                                                                                                                    )
                                                                                            )
                                                                             )
                                      join ftsl_tven t3 on (t3.s_tipovenda = t1.s_descricao)
                                     where t2.u_codproduto_pk = (select cast(valor as integer)
                                                                from temp_ativos
                                                               where s_nome = ''pk_produto''
                                                             )
                                       and t3.u_pkey = (select cast(valor as integer)
                                                          from temp_ativos
                                                         where s_nome = ''pk_tipo_venda''
                                                       )
                                       and t1.u_oi = (select u_orgvenda 
                                         from ftsl_orgv
                                        where u_pkey = (select cast(valor as integer)
                                                          from temp_ativos
                                                         where s_nome = ''pk_org_venda''
                                                       )
                                      )
                                    )
   and t1.S_CATEGORIA_CLIENTE = (select s_codigo 
                                   from ftsl_cate 
                                  where u_pkey = (select u_categoria
                                                    from ftsl_clie
                                                   where u_pkey = (select cast(valor as integer)
                                                                     from temp_ativos
                                                                    where s_nome = ''pk_cliente''
                                                                  )
                                                 )
                                )                                
and t1.u_orgvenda = (select u_orgvenda 
                                         from ftsl_orgv
                                        where u_pkey = (select cast(valor as integer)
                                                          from temp_ativos
                                                         where s_nome = ''pk_org_venda''
                                                       )
                                      )
   and t2.s_ncm = (select t3.s_xilincado
                     from ftsl_prod t3
                    where t3.u_pkey = (select cast(valor as integer)
                                         from temp_ativos
                                        where s_nome = ''pk_produto''
                                      )
                  )
   and t1.s_codregra = ''GET_FISC_CLAS_TX_CODE''
 UNION all
select distinct t1.S_CATEGORIA_IMPOSTO 
     , t2.s_codigo_imposto
     , t1.D_INDICE_PRIORIDADE
     , ( ( (select cast(valor as real) from temp_ativos where s_nome = ''preco_venda'')  
         * ( ( 100
             + coalesce(t2.D_ALIQUOTA_MODIFICACAO_BASE,0)
             )
           / 100 
           ) 
         ) 
       * ( t2.D_ALIQUOTA_IMPOSTO
         / 100
         ) 
       ) as d_valor_imposto
  from tp_regra_imposto t1 
  join tp_imposto_exc_class_fiscal t2 on (t1.S_CATEGORIA_IMPOSTO = t2.S_CATEGORIA_IMPOSTO and t1.u_orgvenda = t2.u_orgvenda)
 where t1.S_ID_TIPO_TRANSACAO_OM = (select t1.u_codtranscab 
                                      from tp_transacoes t1
                                      join tp_orgven_tabela_produto_st t2 on (t1.u_ou=( case when t1.u_oi = 801
                                                                                              and t2.s_codproduto = ''1000000125''
                                                                                              and (select cast(valor as real) from temp_ativos where s_nome = ''preco_venda'') < 3
                                                                                             then 6
                                                                                             when t1.u_oi = 801
                                                                                              and t2.s_codproduto = ''1000000125''
                                                                                              and (select cast(valor as real) from temp_ativos where s_nome = ''preco_venda'') >= 3
                                                                                             then 7
                                                                                             WHEN (select s_codigo 
                                                                                                     from ftsl_cate 
                                                                                                    where u_pkey = (select u_categoria
                                                                                                                      from ftsl_clie
                                                                                                                     where u_pkey = (select cast(valor as integer)
                                                                                                                                       from temp_ativos
                                                                                                                                      where s_nome = ''pk_cliente''
                                                                                                                                    )
                                                                                                                   )
                                                                                                  ) = ''CONTRIB_REG_ESPEC''
                                                                                             THEN 8
                                                                                             else t2.u_status
                                                                                         end
                                                                                      ) 
                                                                              and t1.u_oi = t2.u_orgvenda 
                                                                              and t2.s_uf = ( select s_uf 
                                                                                                from ftsl_ende
                                                                                               where s_codcliente = (select s_codigo 
                                                                                                                       from ftsl_clie
                                                                                                                      where u_pkey = (select cast(valor as integer)
                                                                                                                                        from temp_ativos
                                                                                                                                       where s_nome = ''pk_cliente''
                                                                                                                                     )
                                                                                                                    )
                                                                                            )
                                                                             )
                                      join ftsl_tven t3 on (t3.s_tipovenda = t1.s_descricao)
                                     where t2.u_codproduto_pk = (select cast(valor as integer)
                                                                from temp_ativos
                                                               where s_nome = ''pk_produto''
                                                             )
                                       and t3.u_pkey = (select cast(valor as integer)
                                                          from temp_ativos
                                                         where s_nome = ''pk_tipo_venda''
                                                       )
                                       and t1.u_oi = (select u_orgvenda 
                                         from ftsl_orgv
                                        where u_pkey = (select cast(valor as integer)
                                                          from temp_ativos
                                                         where s_nome = ''pk_org_venda''
                                                       )
                                      )
                                    )
   and t1.S_CATEGORIA_CLIENTE = (select s_codigo 
                                   from ftsl_cate 
                                  where u_pkey = (select u_categoria
                                                    from ftsl_clie
                                                   where u_pkey = (select cast(valor as integer)
                                                                     from temp_ativos
                                                                    where s_nome = ''pk_cliente''
                                                                  )
                                                 )
                                )                                
and t1.u_orgvenda = (select u_orgvenda 
                                         from ftsl_orgv
                                        where u_pkey = (select cast(valor as integer)
                                                          from temp_ativos
                                                         where s_nome = ''pk_org_venda''
                                                       )
                                      )
   and t2.s_uf_origem = (select s_uf 
                          from tp_ov
                         where u_oi = (select u_orgvenda 
                                         from ftsl_orgv
                                        where u_pkey = (select cast(valor as integer)
                                                          from temp_ativos
                                                         where s_nome = ''pk_org_venda''
                                                       )
                                      )  
                        )
   and t2.s_uf_destino = (select s_uf 
                            from ftsl_ende
                           where s_codcliente = (select s_codigo 
                                                   from ftsl_clie
                                                  where u_pkey = (select cast(valor as integer)
                                                                    from temp_ativos
                                                                   where s_nome = ''pk_cliente''
                                                                 )
                                                )
                         )
   and t2.s_ncm = (select t3.s_xilincado
                     from ftsl_prod t3
                    where t3.u_pkey = (select cast(valor as integer)
                                         from temp_ativos
                                        where s_nome = ''pk_produto''
                                      )
                      and t3.u_orgvenda = (select cast(valor as integer)
                                             from temp_ativos
                                            where s_nome = ''pk_produto''
                                          )
                  )
   and t1.s_codregra = ''GET_EXC_FISC_CLAS_TX_CODE''
 UNION all
select distinct t1.S_CATEGORIA_IMPOSTO 
     , t2.s_codigo_imposto
     , t1.D_INDICE_PRIORIDADE
     , ( ( (select cast(valor as real) from temp_ativos where s_nome = ''preco_venda'')  
         * ( ( 100
             + coalesce(t2.D_ALIQUOTA_MODIFICACAO_BASE,0)
             )
           / 100 
           ) 
         ) 
       * ( t2.D_ALIQUOTA_IMPOSTO
         / 100
         ) 
       ) as d_valor_imposto
  from tp_regra_imposto t1 
  join tp_imposto_exc_cliente t2 on (t1.S_CATEGORIA_IMPOSTO = t2.S_CATEGORIA_IMPOSTO and t1.u_orgvenda = t2.u_orgvenda)
 where t1.S_ID_TIPO_TRANSACAO_OM = (select t1.u_codtranscab 
                                      from tp_transacoes t1
                                      join tp_orgven_tabela_produto_st t2 on (t1.u_ou=( case when t1.u_oi = 801
                                                                                              and t2.s_codproduto = ''1000000125''
                                                                                              and (select cast(valor as real) from temp_ativos where s_nome = ''preco_venda'') < 3
                                                                                             then 6
                                                                                             when t1.u_oi = 801
                                                                                              and t2.s_codproduto = ''1000000125''
                                                                                              and (select cast(valor as real) from temp_ativos where s_nome = ''preco_venda'') >= 3
                                                                                             then 7
                                                                                             WHEN (select s_codigo 
                                                                                                     from ftsl_cate 
                                                                                                    where u_pkey = (select u_categoria
                                                                                                                      from ftsl_clie
                                                                                                                     where u_pkey = (select cast(valor as integer)
                                                                                                                                       from temp_ativos
                                                                                                                                      where s_nome = ''pk_cliente''
                                                                                                                                    )
                                                                                                                   )
                                                                                                  ) = ''CONTRIB_REG_ESPEC''
                                                                                             THEN 8
                                                                                             else t2.u_status
                                                                                         end
                                                                                      ) 
                                                                              and t1.u_oi = t2.u_orgvenda 
                                                                              and t2.s_uf = ( select s_uf 
                                                                                                from ftsl_ende
                                                                                               where s_codcliente = (select s_codigo 
                                                                                                                       from ftsl_clie
                                                                                                                      where u_pkey = (select cast(valor as integer)
                                                                                                                                        from temp_ativos
                                                                                                                                       where s_nome = ''pk_cliente''
                                                                                                                                     )
                                                                                                                    )
                                                                                            )
                                                                             )
                                      join ftsl_tven t3 on (t3.s_tipovenda = t1.s_descricao)
                                     where t2.u_codproduto_pk = (select cast(valor as integer)
                                                                from temp_ativos
                                                               where s_nome = ''pk_produto''
                                                             )
                                       and t3.u_pkey = (select cast(valor as integer)
                                                          from temp_ativos
                                                         where s_nome = ''pk_tipo_venda''
                                                       )
                                       and t1.u_oi = (select u_orgvenda 
                                         from ftsl_orgv
                                        where u_pkey = (select cast(valor as integer)
                                                          from temp_ativos
                                                         where s_nome = ''pk_org_venda''
                                                       )
                                      )
                                    )                                    
and t1.u_orgvenda = (select u_orgvenda 
                                         from ftsl_orgv
                                        where u_pkey = (select cast(valor as integer)
                                                          from temp_ativos
                                                         where s_nome = ''pk_org_venda''
                                                       )
                                      )
   and t1.S_CATEGORIA_CLIENTE = (select s_codigo 
                                   from ftsl_cate 
                                  where u_pkey = (select u_categoria
                                                    from ftsl_clie
                                                   where u_pkey = (select cast(valor as integer)
                                                                     from temp_ativos
                                                                    where s_nome = ''pk_cliente''
                                                                  )
                                                 )
                                )
   and t2.s_id_endereco = (select s_codigo
                             from ftsl_clie
                            where u_pkey = (select cast(valor as integer)
                                              from temp_ativos
                                             where s_nome = ''pk_cliente''
                                           )
                          )
   and t1.s_codregra = ''GET_EXC_FISC_CLAS_TX_CODE'' 
 UNION all
select S_CATEGORIA_IMPOSTO 
     , s_codigo_imposto
     , D_INDICE_PRIORIDADE
     , d_valor_imposto
  from (select S_CATEGORIA_IMPOSTO 
             , s_codigo_imposto
             , D_INDICE_PRIORIDADE
             , case when d_aliquota_base_composta is null
                    then (case when s_flag_substituicao_tributaria = ''N''
                               then ( ( (select cast(valor as real) from temp_ativos where s_nome = ''preco_venda'')  
                                      * ( ( 100
                                          + coalesce(D_ALIQUOTA_MODIFICACAO_BASE,0)
                                          )
                                        / 100 
                                        ) 
                                      ) 
                                      * ( D_ALIQUOTA_IMPOSTO
                                        / 100
                                        )
                                    ) 
                               else ( 0/*não tenho dados da regra*/
                                    )
                           end
                         )
                    else (case when s_flag_substituicao_tributaria = ''N''
                               then ( 0 /*não tenho dados da regra*/
                                    ) 
                               else ( (
                                        ( (select cast(valor as real) from temp_ativos where s_nome = ''preco_venda'')  
                                        * ( ( 100
                                            + coalesce(d_aliquota_base_composta,0)
                                            )
                                          / 100 
                                          ) 
                                        * ( ( 100
                                            + coalesce(D_ALIQUOTA_MODIFICACAO_BASE,0)
                                            )
                                          / 100 
                                          )
                                        ) 
                                      - ( (select cast(valor as real) from temp_ativos where s_nome = ''preco_venda'')  
                                        * ( ( 100
                                            + coalesce(d_aliquota_base_composta,0)
                                            )
                                          / 100 
                                          )
                                        )
                                      ) 
                                      * ( D_ALIQUOTA_IMPOSTO
                                        / 100
                                        )
                                    )
                           end
                         )
                end as d_valor_imposto
          from (select distinct t1.S_CATEGORIA_IMPOSTO 
                     , t2.s_codigo_imposto
                     , t1.D_INDICE_PRIORIDADE
                     , t2.d_aliquota_imposto
                     , t2.d_aliquota_modificacao_base
                     , t2.s_flag_substituicao_tributaria
                     , t2.s_imposto_incluido
                     , case when t2.s_categoria_imp_base_composta is null
                            then null
                            else ((select coalesce(d_aliquota_modificacao_base,0) 
                                     from tp_GRUPO_IMPOSTO t3
                                    where t3.s_grupo_imposto = t2.s_grupo_imposto
                                      and t2.s_categoria_imp_base_composta = t3.S_CATEGORIA_IMPOSTO
                                  )/100
                                 )
                        end as d_aliquota_base_composta
                  from tp_regra_imposto t1
                  join tp_GRUPO_IMPOSTO t2 on (t1.S_CATEGORIA_IMPOSTO = t2.S_CATEGORIA_IMPOSTO and t1.u_orgvenda = t2.u_orgvenda)
                 where t1.S_ID_TIPO_TRANSACAO_OM = (select t1.u_codtranscab 
                                      from tp_transacoes t1
                                      join tp_orgven_tabela_produto_st t2 on (t1.u_ou=( case when t1.u_oi = 801
                                                                                              and t2.s_codproduto = ''1000000125''
                                                                                              and (select cast(valor as real) from temp_ativos where s_nome = ''preco_venda'') < 3
                                                                                             then 6
                                                                                             when t1.u_oi = 801
                                                                                              and t2.s_codproduto = ''1000000125''
                                                                                              and (select cast(valor as real) from temp_ativos where s_nome = ''preco_venda'') >= 3
                                                                                             then 7
                                                                                             WHEN (select s_codigo 
                                                                                                     from ftsl_cate 
                                                                                                    where u_pkey = (select u_categoria
                                                                                                                      from ftsl_clie
                                                                                                                     where u_pkey = (select cast(valor as integer)
                                                                                                                                       from temp_ativos
                                                                                                                                      where s_nome = ''pk_cliente''
                                                                                                                                    )
                                                                                                                   )
                                                                                                  ) = ''CONTRIB_REG_ESPEC''
                                                                                             THEN 8
                                                                                             else t2.u_status
                                                                                         end
                                                                                      ) 
                                                                              and t1.u_oi = t2.u_orgvenda 
                                                                              and t2.s_uf = ( select s_uf 
                                                                                                from ftsl_ende
                                                                                               where s_codcliente = (select s_codigo 
                                                                                                                       from ftsl_clie
                                                                                                                      where u_pkey = (select cast(valor as integer)
                                                                                                                                        from temp_ativos
                                                                                                                                       where s_nome = ''pk_cliente''
                                                                                                                                     )
                                                                                                                    )
                                                                                            )
                                                                             )
                                      join ftsl_tven t3 on (t3.s_tipovenda = t1.s_descricao)
                                     where t2.u_codproduto_pk = (select cast(valor as integer)
                                                                from temp_ativos
                                                               where s_nome = ''pk_produto''
                                                             )
                                       and t3.u_pkey = (select cast(valor as integer)
                                                          from temp_ativos
                                                         where s_nome = ''pk_tipo_venda''
                                                       )
                                       and t1.u_oi = (select u_orgvenda 
                                         from ftsl_orgv
                                        where u_pkey = (select cast(valor as integer)
                                                          from temp_ativos
                                                         where s_nome = ''pk_org_venda''
                                                       )
                                      )
                                    )
                   and t1.S_CATEGORIA_CLIENTE = (select s_codigo 
                                                   from ftsl_cate 
                                                  where u_pkey = (select u_categoria
                                                                    from ftsl_clie
                                                                   where u_pkey = (select cast(valor as integer)
                                                                                     from temp_ativos
                                                                                    where s_nome = ''pk_cliente''
                                                                                  )
                                                                 )
                                                )                                                
and t1.u_orgvenda = (select u_orgvenda 
                                         from ftsl_orgv
                                        where u_pkey = (select cast(valor as integer)
                                                          from temp_ativos
                                                         where s_nome = ''pk_org_venda''
                                                       )
                                      )
                   and t1.s_codregra = ''GET_LATIN_TX_GRP_TX_CODE''
                   and t2.s_grupo_imposto = t1.s_grupo_imposto
               ) t1
       )  
 order by S_CATEGORIA_IMPOSTO
        , D_INDICE_PRIORIDADE asc
) 
, cte_imp_prior as (
select t1.* 
  from cte_impostos t1
  LEFT OUTER JOIN cte_impostos t2 on (t1.S_CATEGORIA_IMPOSTO = t2.S_CATEGORIA_IMPOSTO
                                      and t1.D_INDICE_PRIORIDADE > t2.D_INDICE_PRIORIDADE)
 where t2.S_CATEGORIA_IMPOSTO is null
 order by t1.s_categoria_imposto
)
insert into temp_impostos
select (select cast(valor as integer) 
          from temp_ativos 
         where s_nome = ''pk_produto''
       ) as u_codproduto
     , s_categoria_imposto
     , s_codigo_imposto  
     , d_valor_imposto as d_valor_imposto
  from cte_imp_prior;');  
commit;
